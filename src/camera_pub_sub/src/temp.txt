#include <stdio.h>
#include <libudev.h>


int main() {
    struct udev *udev = udev_new();
    if (!udev) {
        printf("Failed to create udev context\n");
        return 1;
    }

    struct udev_enumerate *enumerate = udev_enumerate_new(udev);
    udev_enumerate_add_match_subsystem(enumerate, "tty");
    udev_enumerate_scan_devices(enumerate);

    struct udev_list_entry *devices = udev_enumerate_get_list_entry(enumerate);
    struct udev_list_entry *entry;
    udev_list_entry_foreach(entry, devices) {
        const char *path = udev_list_entry_get_name(entry);
        
        struct udev_device *dev = udev_device_new_from_syspath(udev, path);

        struct udev_device* usb = udev_device_get_parent_with_subsystem_devtype(
            dev, "usb", "usb_device");

        const char *name = udev_device_get_sysname(usb);
        const char *serial = udev_device_get_sysattr_value(usb, "iSerial");

        printf("iSerial USB value: %s\n", serial);
        printf("USB device: %s\n", name);
        udev_device_unref(dev);
    }

    udev_enumerate_unref(enumerate);
    udev_unref(udev);

    return 0;
}